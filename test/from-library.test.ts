import test from 'ava';
// @ts-ignore
import browserEnv from 'browser-env';

browserEnv();

import { parseLibraryPage } from '../src/api/from-library';

test('One book', t => {
  const html = `
        <div id="adbl-library-content-row-B011LR4PW4" class="adbl-library-content-row"> <div id="" class="bc-row-responsive bc-spacing-top-s2" style=""> <div class="bc-col-responsive bc-spacing-top-none bc-col-2"> <div id="" class="bc-row-responsive" style=""> <a class="bc-link bc-color-link" tabindex="0" href="/pd/Skunk-Works-Audiobook/B011LR4PW4?ref=a_library_t_c5_libItem_&pf_rd_p=592f90bd-7f7b-4bfc-afa2-b002e52e7228&pf_rd_r=EK28B40CXC0E73P7NBEF"> <noscript> <img id="nojs_img_" class="bc-pub-block bc-image-inset-border" loading="lazy" src="" alt="Skunk Works audiobook cover art"/> </noscript> <img id="" class="bc-pub-block bc-image-inset-border js-only-element" src="https://m.media-amazon.com/images/I/51-XJRg2dCL._SL500_.jpg" alt="Skunk Works audiobook cover art"/> </a> </div> </div> <div class="bc-col-responsive bc-spacing-top-none bc-col-10"> <div id="" class="bc-row-responsive display-flex" style=""> <div class="bc-col-responsive bc-col-9"> <span> <ul class="bc-list bc-list-nostyle"> <li class="bc-list-item bc-spacing-s0_5"> <a class="bc-link bc-color-base" tabindex="0" href="/pd/Skunk-Works-Audiobook/B011LR4PW4?ref=a_library_t_c5_libItem_&pf_rd_p=592f90bd-7f7b-4bfc-afa2-b002e52e7228&pf_rd_r=EK28B40CXC0E73P7NBEF"> <span class="bc-text bc-size-headline3">Skunk Works: A Personal Memoir of My Years of Lockheed</span> </a> </li> <li class="bc-list-item authorLabel bc-spacing-s0_5"> <span class="bc-text bc-color-secondary"> By: <a class="bc-link bc-color-base" tabindex="0" href="/author/Ben-R-Rich/B000AQ27BE?ref=a_library_t_c5_libItem_author_0&pf_rd_p=592f90bd-7f7b-4bfc-afa2-b002e52e7228&pf_rd_r=EK28B40CXC0E73P7NBEF"> <span class="bc-text bc-size-callout">Ben R. Rich</span> </a>, <a class="bc-link bc-color-base" tabindex="0" href="/author/Leo-Janos/B000AQ4TEM?ref=a_library_t_c5_libItem_author_0&pf_rd_p=592f90bd-7f7b-4bfc-afa2-b002e52e7228&pf_rd_r=EK28B40CXC0E73P7NBEF"> <span class="bc-text bc-size-callout">Leo Janos</span> </a> </span> </li> <li class="bc-list-item narratorLabel bc-spacing-s0_5"> <span class="bc-text bc-color-secondary"> Narrated by: <a class="bc-link bc-color-base" tabindex="0" href="/search?searchNarrator=Pete+Larkin&ref=a_library_t_c5_libItem_narrator_0&pf_rd_p=592f90bd-7f7b-4bfc-afa2-b002e52e7228&pf_rd_r=EK28B40CXC0E73P7NBEF"> <span class="bc-text bc-size-callout">Pete Larkin</span> </a> </span> </li> <li class="bc-list-item rateAndReviewLabel bc-spacing-s0_5"> <div class="bc-box bc-box-padding-none adbl-prod-rate-review-bar-group bc-spacing-top-none"> <input type="hidden" name="asinForRatingStars" value="B011LR4PW4" class="asin-for-rating-stars"> <input type="hidden" name="ratingsCsrfToken" value="gpBvsWrb/AMOJRXtMtL7DL7osE+GwzTDBeKsS0MAAAABAAAAAF9XPCpyYXcAAAAAFVfwRGgNifE9xfqJS///" class="ratings-csrf-token"> <div class="bc-trigger bc-trigger-tooltip"> <div class="bc-rating-stars adbl-prod-rate-review-bar adbl-prod-rate-review-bar-overall" data-star-count="0" role="radiogroup" tabindex="0" asin=B011LR4PW4> <h3 class="bc-pub-offscreen">interactive rating stars</h3> <span class="bc-rating-star" data-index="1" data-text="Not for me" role="radio" aria-checked="false" aria-label="Not for me" tabindex="0"> <i aria-hidden="true" class="bc-icon bc-icon-star-hollow bc-icon-size-small bc-color-tertiary"> </i> </span> <span class="bc-rating-star" data-index="2" data-text="It's okay" role="radio" aria-checked="false" aria-label="It's okay" tabindex="0"> <i aria-hidden="true" class="bc-icon bc-icon-star-hollow bc-icon-size-small bc-color-tertiary"> </i> </span> <span class="bc-rating-star" data-index="3" data-text="Pretty good" role="radio" aria-checked="false" aria-label="Pretty good" tabindex="0"> <i aria-hidden="true" class="bc-icon bc-icon-star-hollow bc-icon-size-small bc-color-tertiary"> </i> </span> <span class="bc-rating-star" data-index="4" data-text="It's great" role="radio" aria-checked="false" aria-label="It's great" tabindex="0"> <i aria-hidden="true" class="bc-icon bc-icon-star-hollow bc-icon-size-small bc-color-tertiary"> </i> </span> <span class="bc-rating-star" data-index="5" data-text="I love it" role="radio" aria-checked="false" aria-label="I love it" tabindex="0"> <i aria-hidden="true" class="bc-icon bc-icon-star-hollow bc-icon-size-small bc-color-tertiary"> </i> </span> </div> <div class="bc-tooltip bc-tooltip-left bc-hidden  bc-palette-inverse bc-rating-stars-tooltip" role="tooltip"> <div class="bc-tooltip-inner bc-color-background-inverse bc-color-background-base"> <div class="bc-tooltip-message bc-color-base"> </div> </div> </div> </div> &nbsp; <a class="bc-link bc-color-base" tabindex="0" href="/write-review?rdpath=%2Fpd%2FB011LR4PW4&asin=B011LR4PW4&source=lib&page=1&ref=a_library_t_c5_review&pf_rd_p=592f90bd-7f7b-4bfc-afa2-b002e52e7228&pf_rd_r=EK28B40CXC0E73P7NBEF">Write a review</a> </div> </li> <li class="bc-list-item summaryLabel bc-spacing-s0_5 bc-spacing-top-s1"> <span class="bc-text merchandisingSummary bc-size-body bc-color-secondary">From the development of the U-2 to the Stealth fighter, the never-before-told story behind America's high-stakes quest to dominate the skies....</span> </li> <li class="bc-list-item"> <input type="hidden" name="isFinished" value="true"/> <div class="bc-box bc-box-padding-none adbl-library-item-button-row bc-spacing-top-s1" data-asin='B011LR4PW4' data-collection-id=''> <span id="add-to-favorites-button-B011LR4PW4" class="bc-button bc-button-simple add-to-favorites-button bc-button-small bc-button-inline"> <button class="bc-button-text" type="button" tabindex="0"> <span class="bc-text bc-button-text-inner bc-size-action-small"> <span class="favorite-icon library-button-row-icon">&nbsp;</span> <span class="bc-text">Add to favorites</span> </span> </button> </span> <span id="remove-from-favorites-button-B011LR4PW4" class="bc-button bc-button-simple remove-from-favorites-button bc-pub-hidden bc-button-small bc-button-inline"> <button class="bc-button-text" type="button" tabindex="0"> <span class="bc-text bc-button-text-inner bc-size-action-small"> <span class="unfavorite-icon library-button-row-icon">&nbsp;</span> <span class="bc-text">Remove from favorites</span> </span> </button> </span> <span class="bc-button bc-button-simple add-item-to-collection-button bc-button-small bc-button-inline"> <button class="bc-button-text" type="button" tabindex="0"> <span class="bc-text bc-button-text-inner bc-size-action-small"> <span class="add-to-collection-icon library-button-row-icon">&nbsp;</span> <span class="bc-text">Add to...</span> </span> </button> </span> <input type="hidden" name="collectionIds-B011LR4PW4" value="" id="collectionIds-B011LR4PW4"> <!-- These input fields are needed to localize success and failure toasts for adding to and removing from favorites--> <input type="hidden" name="addToFavoritesSuccessMessage" value="Successfully added to Favorites"> <input type="hidden" name="addToFavoritesFailureMessage" value="Failed to add to Favorites"> <input type="hidden" name="removeFromFavoritesSuccessMessage" value="Successfully removed from Favorites"> <input type="hidden" name="removeFromFavoritesFailureMessage" value="Failed to remove from Favorites"> <!-- These input fields are needed to localize success and failure toasts for removing from a collection--> <input type="hidden" name="removeFromCollectionSuccessMessage" value="Successfully removed from collection"> <input type="hidden" name="removeFromCollectionFailureMessage" value="Failed to remove from collection"> <span id="mark-as-unfinished-button-B011LR4PW4" class="bc-button bc-button-simple mark-as-unfinished-button bc-button-small bc-button-inline"> <button class="bc-button-text" type="button" tabindex="0"> <span class="bc-text bc-button-text-inner bc-size-action-small"> <span class="unfinished-icon library-button-row-icon">&nbsp;</span> <span class="bc-text small-padding-left">Mark as Unfinished</span> </span> </button> </span> <span id="mark-as-finished-button-B011LR4PW4" class="bc-button bc-button-simple mark-as-finished-button bc-pub-hidden bc-button-small bc-button-inline"> <button class="bc-button-text" type="button" tabindex="0"> <span class="bc-text bc-button-text-inner bc-size-action-small"> <span class="finished-icon library-button-row-icon">&nbsp;</span> <span class="bc-text small-padding-left">Mark as Finished</span> </span> </button> </span> </div> </li> </ul> </span> </div> <div class="bc-col-responsive adbl-library-select-row-checkbox bc-pub-hidden bc-col-1 bc-col-offset-2"> <div style="height: 171px;" class="bc-box bc-box-padding-base checkbox-container"> <div id="" class="bc-checkbox adbl-library-item-select-checkbox adbl-library-item-select-checkbox-B011LR4PW4"> <label class="bc-label-wrapper "> <div class="bc-checkbox-wrapper"> <input type="checkbox" autocomplete="off" data-asin='B011LR4PW4' data-img-url='https://m.media-amazon.com/images/I/51-XJRg2dCL._SL500_.jpg' data-img-alt-text='Skunk Works audiobook cover art'/> <span class="bc-checkbox-icon-container bc-color-border-base"> <span class="bc-checkbox-icon-inner"> <div class="bc-color-background-active bc-checkbox-check"> <i aria-hidden="true" class="bc-icon bc-checkbox-icon bc-icon-check bc-color-inverse"> </i> </div> </span> </span> </div> <span class="bc-checkbox-label bc-size-callout"> </span> </label> </div> </div> </div> <div class="bc-col-responsive adbl-library-action bc-col-2 bc-col-offset-1"> <div id="" class="bc-row-responsive bc-spacing-top-s2" style=""> <span class="bc-text bc-color-secondary" id="time-remaining-finished-B011LR4PW4"> Finished </span> </div> <div id="" class="bc-row-responsive adbl-library-item bc-spacing-top-s2" style=""> <input type="hidden" name="asin" value="B011LR4PW4"> <input type="hidden" name="contentType" value="Product"> <input type="hidden" name="asinIndex" value="0"> <span class="bc-button bc-button-primary adbl-library-listen-now-button bc-button-small"> <button class="bc-button-text" type="button" tabindex="0"> <span class="bc-text bc-button-text-inner bc-size-action-small"> <span class="bc-text bc-size-callout">Listen now</span> </span> </button> </span> </div> <div id="" class="bc-row-responsive bc-spacing-top-s2" style=""> <span class="bc-button bc-button-secondary adbl-lib-action-download bc-button-small"> <a class="bc-button-text" target='_blank' href="/companion-file/B011LR4PW4" tabindex="0"> <span class="bc-text bc-button-text-inner bc-size-action-small"> <span class="bc-text bc-size-callout">View PDF</span> </span> </a> </span> </div> <div id="" class="bc-row-responsive bc-spacing-top-s2" style=""> <div data-trigger="library-download-popover-B011LR4PW4" class="bc-trigger library-download-button bc-trigger-popover"> <span class="bc-button bc-button-secondary adbl-lib-action-download bc-button-small"> <a class="bc-button-text" href="https://cds.audible.com/download?asin=B011LR4PW4&cust_id=Y3Obrwdoor-DVcJEIvn6BBilwrVrMaTGOfhst-skPeqnpW_pd0bPRkcPu0zPpg&codec=LC_64_22050_Stereo&source=Audible&type=AUDI" tabindex="0"> <span class="bc-text bc-button-text-inner bc-size-action-small"> <span class="bc-text bc-size-callout">Download</span> </span> </a> </span> </div> <div id="library-download-popover-B011LR4PW4" class="bc-popover bc-hidden bc-hoverable bc-palette-default" role="tooltip" aria-label="Download" data-popover-position="bottom" data-width=140 data-hoverable="true" data-bodyLevel=""> <span class="bc-popover-beak"></span> <div class="bc-popover-inner" style=""> <a class="bc-link bc-color-base" tabindex="0" aria-label='DownloadFull' href="https://cds.audible.com/download?asin=B011LR4PW4&cust_id=Y3Obrwdoor-DVcJEIvn6BBilwrVrMaTGOfhst-skPeqnpW_pd0bPRkcPu0zPpg&codec=LC_64_22050_Stereo&source=Audible&type=AUDI"> <div id="" class="bc-row-responsive bc-spacing-s2" style=""> <div class="bc-col-responsive bc-col-9"> <span class="bc-text bc-size-title2">Full</span> </div> <div class="bc-col-responsive bc-col-3"> <i aria-hidden="true" class="bc-icon bc-icon-download"> </i> </div> </div> </a> <a class="bc-link bc-color-base" tabindex="0" aria-label='DownloadPart 1' href="https://cds.audible.com/download?asin=B011LR4YU2&cust_id=56oZgvRX23Tj5Mde1LMgZdLf8m7YUqi0Tj532weizjzGmxZ0bMCg2F1FxRQ_UQ&codec=LC_64_22050_Stereo&source=Audible&type=AUDI"> <div id="" class="bc-row-responsive bc-spacing-s2" style=""> <div class="bc-col-responsive bc-col-9"> <span class="bc-text bc-size-title2">Part 1</span> </div> <div class="bc-col-responsive bc-col-3"> <i aria-hidden="true" class="bc-icon bc-icon-download"> </i> </div> </div> </a> <a class="bc-link bc-color-base" tabindex="0" aria-label='DownloadPart 2' href="https://cds.audible.com/download?asin=B011LR510E&cust_id=O4yfYVdCfixkxong66JoruI2iaV1zcTseE29JVn8H0PQTvsOmSd85wB8yIEfeg&codec=LC_64_22050_Stereo&source=Audible&type=AUDI"> <div id="" class="bc-row-responsive bc-spacing-s0" style=""> <div class="bc-col-responsive bc-col-9"> <span class="bc-text bc-size-title2">Part 2</span> </div> <div class="bc-col-responsive bc-col-3"> <i aria-hidden="true" class="bc-icon bc-icon-download"> </i> </div> </div> </a> </div> </div> </div> <div id="" class="bc-row-responsive bc-spacing-top-s2" style=""> <span class="bc-text bc-size-caption1 bc-color-secondary"> You downloaded this title </span> </div> </div> </div> </div> </div> <div id="" class="bc-row-responsive bc-spacing-top-base bc-spacing-base" style=""> <div class="bc-col-responsive bc-col-10 bc-col-offset-2"> <div id="" class="bc-row-responsive library-item-divider" style=""> <div class="bc-divider bc-divider-secondary"> </div> </div> </div> </div> </div> `;

  const res = parseLibraryPage(html);

  t.is(res.books.length, 1);
  t.is(res.pageCount, 1);
  t.deepEqual(res.books[0], {
    id: 'B011LR4PW4',
    authors: ['Ben R. Rich', 'Leo Janos'],
  });
});
